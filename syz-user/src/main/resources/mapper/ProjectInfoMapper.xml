<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cuco.syzuser.mapper.ProjectInfoMapper">
    
    <!-- 根据项目 ID 查询 -->
    <select id="findById" resultType="com.cuco.syzuser.entity.ProjectInfo">
        SELECT * FROM biz_project_info WHERE project_id = #{projectId} AND deleted = 0
    </select>
    
    <!-- 根据模态标识 ID 查询项目列表 -->
    <select id="findByModalId" resultType="com.cuco.syzuser.entity.ProjectInfo">
        SELECT * FROM biz_project_info WHERE modal_id = #{modalId} AND deleted = 0 ORDER BY upload_time DESC
    </select>
        
    <!-- 根据用户 ID 查询项目列表 -->
    <select id="findByUserId" resultType="com.cuco.syzuser.entity.ProjectInfo">
        SELECT * FROM biz_project_info WHERE user_id = #{userId} AND deleted = 0 ORDER BY upload_time DESC
    </select>
    
    <!-- 插入项目信息 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="projectId" keyColumn="project_id">
        INSERT INTO biz_project_info(modal_id,user_id, project_name, byte_size, project_type, cloud_storage_url, project_desc, upload_time, project_status, deleted)
        VALUES(#{modalId},#{userId}, #{projectName}, #{byteSize}, #{projectType}, #{cloudStorageUrl}, #{projectDesc}, NOW(), #{projectStatus}, #{deleted})
    </insert>
    
    <!-- 更新项目信息 -->
    <update id="update">
        UPDATE biz_project_info 
        SET project_name = #{projectName},
            project_type = #{projectType},
            cloud_storage_url = #{cloudStorageUrl},
            project_desc = #{projectDesc},
            project_status = #{projectStatus}
        WHERE project_id = #{projectId}
    </update>
    
    <!-- 更新项目状态 -->
    <update id="updateStatus">
        UPDATE biz_project_info SET project_status = #{projectStatus} WHERE project_id = #{projectId}
    </update>
    
    <!-- 逻辑删除项目 -->
    <update id="deleteById">
        UPDATE biz_project_info SET deleted = 1, delete_time = NOW() WHERE project_id = #{projectId}
    </update>
    
    <!-- 查询所有可用项目类型 -->
    <select id="findAllAvailableProjects" resultType="com.cuco.syzuser.entity.ProjectInfo">
        SELECT DISTINCT project_type, project_name, project_desc 
        FROM biz_project_info 
        WHERE project_status = 'ONLINE' AND deleted = 0
        GROUP BY project_type
        ORDER BY upload_time DESC
    </select>
    
    <!-- 根据项目类型查询 -->
    <select id="findByProjectType" resultType="com.cuco.syzuser.entity.ProjectInfo">
        SELECT * FROM biz_project_info 
        WHERE project_type = #{projectType} 
        AND project_status = 'ONLINE' 
        AND deleted = 0
        AND modal_id IS NULL
        LIMIT 1
    </select>
    
</mapper>
