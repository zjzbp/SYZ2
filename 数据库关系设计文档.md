# 数据库表关系设计文档

## 📋 完整业务流程

### 业务流程图

```
用户注册
    ↓
生成双因子码 (TFC-XXXXXXXX)
    ↓
保存到 biz_two_factor_code 表（grid_code_value 为空）
    ↓
用户填写网格码
    ↓
保存到 biz_grid_code 表
    ↓
更新 biz_two_factor_code.grid_code_value（绑定网格码）
    ↓
用户绑定模态标识（资产确权）
    ↓
保存到 biz_modal_identifier 表（关联双因子码）
    ↓
用户选择活动类型（口述历史/非遗记录/文档存档等）
    ↓
保存到 biz_project_info 表（一个模态标识对应一个活动）
```

### 1. 完整业务流程详解

#### 步骤1：用户注册
```sql
-- 1. 插入用户记录
INSERT INTO user (name, phone, password, two_factor_code, is_fillin)
VALUES ('张三', '13800138000', '123456', 'TFC-12345678', 0);

-- 2. 保存双因子码到 biz_two_factor_code 表
INSERT INTO biz_two_factor_code (two_factor_value, user_id, grid_code_value, code_type, status)
VALUES ('TFC-12345678', 1, NULL, 'PERSONAL', 'ACTIVATED');
-- 注意：此时 grid_code_value 为 NULL，因为用户还未填写网格码
```

#### 步骤2：用户填写网格码
```sql
-- 1. 保存网格码到 biz_grid_code 表
INSERT INTO biz_grid_code (grid_code_value, user_id, status)
VALUES ('GC-87654321', 1, 'VALID');

-- 2. 更新 biz_two_factor_code 表，绑定网格码
UPDATE biz_two_factor_code 
SET grid_code_value = 'GC-87654321'
WHERE user_id = 1 AND deleted = 0;

-- 3. 更新 user 表，保存网格码和填写状态
UPDATE user 
SET grid_code = 'GC-87654321', is_fillin = 1
WHERE id = 1 AND deleted = 0;
```

#### 步骤3：用户绑定模态标识（资产确权）
```sql
-- 1. 检查用户是否已使用过该模态标识
SELECT COUNT(*) FROM user_modal 
WHERE user_id = 1 AND modal_id = 88888888 AND deleted = 0;

-- 2. 如果未使用过，保存到 biz_modal_identifier 表
INSERT INTO biz_modal_identifier (modal_value, two_factor_value, user_id, identifier_type, status)
VALUES (88888888, 'TFC-12345678', 1, 'PROJECT', 'VALID');
-- 获取自增主键 modal_id，假设为 100

-- 3. 保存到 user_modal 表（历史记录）
INSERT INTO user_modal (user_id, modal_id)
VALUES (1, 88888888);

-- 4. 更新 user 表当前使用的模态标识
UPDATE user 
SET modal_id = 88888888
WHERE id = 1 AND deleted = 0;
```

#### 步骤4：用户创建活动/项目
```sql
-- 1. 用户选择活动类型并创建项目
INSERT INTO biz_project_info (
  modal_id, modal_value, user_id, 
  project_name, project_type, 
  cloud_storage_url, project_desc, project_status
)
VALUES (
  100, 88888888, 1,
  '张三口述历史-2025', '口述历史',
  'https://cloud.example.com/projects/100', '张三先生的人生经历记录', 'ONLINE'
);
-- 注意：一个模态标识只能对应一个活动（uk_modal_id 唯一约束）
```

### 2. 数量关系

| 层级 | 关系 | 说明 |
|------|------|------|
| 1个用户 | → | 1个双因子码（注册时生成） |
| 1个双因子码 | → | 1个网格码（填写信息后绑定） |
| 1个双因子码 | → | 最多1亿个模态标识（0-99999999） |
| 1个模态标识 | → | 1个活动/项目（唯一对应） |

### 3. 表结构详解

#### 3.1 用户表 (user)
```sql
用户基础信息
- id: 主键
- name: 用户姓名
- phone: 手机号 (登录凭证)
- two_factor_code: 双因子码 (唯一，关联 biz_two_factor_code)
- grid_code: 网格码 (冗余字段，来自 biz_grid_code)
- password: 密码
- modal_id: 当前使用的模态标识 (冗余字段)
- is_fillin: 是否填写信息
- deleted: 逻辑删除标记
```

#### 3.2 双因子码表 (biz_two_factor_code)
```sql
双因子码与网格码的关联（注册时创建，填写信息后绑定网格码）
- two_factor_id: 主键
- two_factor_value: 双因子码值（TFC-XXXXXXXX，唯一）
- user_id: 用户ID（逻辑外键 -> user.id）
- grid_code_value: 关联的网格码值（逻辑外键 -> biz_grid_code，初始为NULL）
- code_type: 码类型 (ASSET/PERSONAL)
- status: 状态 (ACTIVATED/FROZEN/INVALID)
- deleted: 逻辑删除标记

业务流程：
1. 用户注册时创建记录，grid_code_value = NULL
2. 用户填写网格码后，更新 grid_code_value
```

#### 3.3 网格码表 (biz_grid_code)
```sql
网格码基础信息（用户填写信息时创建）
- grid_code_id: 主键
- grid_code_value: 网格码值（用户填写，唯一）
- user_id: 用户ID（逻辑外键 -> user.id）
- status: 状态 (VALID/INVALID)
- hash_value: 区块链存证哈希
- deposit_record_id: 区块链存证记录ID
- deleted: 逻辑删除标记

业务流程：
1. 用户填写网格码时创建记录
2. 同时更新 biz_two_factor_code.grid_code_value 完成绑定
```

#### 3.4 模态标识表 (biz_modal_identifier)
```sql
模态标识（确权最小单元）
- modal_id: 主键 (自增)
- modal_value: 模态标识值 (0-99999999，用户选择)
- two_factor_value: 关联双因子码 (逻辑外键)
- user_id: 关联用户ID (逻辑外键)
- identifier_type: 标识类型 (PROJECT-项目类)
- status: 状态 (VALID/INVALID)
- hash_value: 区块链存证哈希
- deleted: 逻辑删除标记

约束：
- uk_user_modal_value: (user_id, modal_value, deleted) 唯一
- 一个用户不能重复选择相同的 modal_value
```

#### 3.5 项目信息表 (biz_project_info)
```sql
活动/项目详细信息（一个模态标识对应一个活动）
- project_id: 主键
- modal_id: 关联模态标识ID (逻辑外键，唯一约束)
- modal_value: 模态标识值 (冗余字段)
- user_id: 用户ID (冗余字段)
- project_name: 项目/活动名称
- project_type: 活动类型（口述历史、非遗记录、文档存档等）
- cloud_storage_url: 云仓库URL
- project_desc: 项目描述
- project_status: 项目状态 (ONLINE/OFFLINE)
- deleted: 逻辑删除标记

约束：
- uk_modal_id: (modal_id, deleted) 唯一
- 一个模态标识只能对应一个活动/项目

活动类型示例：
- 口述历史：记录个人口述历史资料
- 非遗记录：非物质文化遗产记录
- 文档存档：重要文档长期存档
- 艺术作品：艺术创作作品存档
- 学术研究：学术研究资料存档
```

#### 3.6 用户模态关联表 (user_modal)
```sql
记录用户使用过的所有模态标识
- id: 主键
- user_id: 用户ID
- modal_id: 模态标识值 (0-99999999)
- create_time: 创建时间
- deleted: 逻辑删除标记

约束：
- uk_user_modal: (user_id, modal_id, deleted) 唯一
```

### 4. 业务流程示例

#### 4.1 用户注册流程
```
1. 用户注册 → 生成 two_factor_code (TFC-XXXXXXXX)
2. 用户填写信息 → 获得 grid_code
3. 系统检查 biz_two_factor_code 表
   - 如果不存在该双因子码，创建记录并关联网格码
   - 如果存在，验证网格码是否匹配
4. 系统更新 user 表的 two_factor_code 和 grid_code 字段
```

#### 4.2 资产确权流程
```
1. 用户选择模态标识 (0-99999999)
2. 系统验证：
   - 该用户是否已使用过该 modal_value (查询 user_modal)
   - 如果已使用，提示错误
3. 创建 biz_modal_identifier 记录：
   - modal_value: 用户选择的值
   - two_factor_value: 用户的双因子码
   - user_id: 用户ID
4. 插入 user_modal 记录（历史追踪）
5. 更新 user.modal_id 为当前使用的模态标识
```

#### 4.3 创建项目流程
```
1. 用户选择一个已绑定的模态标识
2. 创建项目信息：
   - 关联 modal_id
   - 填写项目名称、类型、描述
   - 上传文件到云仓库，获取 URL
3. 系统创建 biz_project_info 记录
4. 一个模态标识只能对应一个项目
```

### 5. 设计特点

#### 5.1 逻辑外键设计
- ❌ 不使用物理外键 (FOREIGN KEY)
- ✅ 使用索引 + 注释说明关联关系
- ✅ 在应用层（Service层）控制数据完整性

#### 5.2 逻辑删除设计
- 所有表包含 `deleted` 字段 (0-未删除, 1-已删除)
- 唯一索引包含 `deleted` 字段
- 删除操作：UPDATE table SET deleted = 1, delete_time = NOW()
- 查询操作：WHERE deleted = 0

#### 5.3 数据冗余设计
- user 表冗余 grid_code 和 modal_id (便于快速查询)
- biz_project_info 表冗余 modal_value 和 user_id (便于统计分析)

#### 5.4 审计追踪
- 所有表包含 create_time 和 update_time
- user_modal 表记录所有使用历史
- 逻辑删除保留完整数据历史

### 6. 查询示例

#### 6.1 获取用户的完整信息链路
```sql
SELECT 
    u.id as user_id,
    u.name as user_name,
    u.phone,
    u.two_factor_code,
    u.grid_code,
    tfc.code_type,
    tfc.status as two_factor_status,
    gc.hash_value as grid_hash_value
FROM user u
LEFT JOIN biz_two_factor_code tfc ON u.two_factor_code = tfc.two_factor_value AND tfc.deleted = 0
LEFT JOIN biz_grid_code gc ON tfc.grid_code_value = gc.grid_code_value AND gc.deleted = 0
WHERE u.id = ? AND u.deleted = 0;
```

#### 6.2 获取用户的所有模态标识和项目
```sql
SELECT 
    mi.modal_value,
    mi.status as modal_status,
    p.project_name,
    p.project_type,
    p.project_status,
    p.cloud_storage_url,
    p.create_time
FROM biz_modal_identifier mi
LEFT JOIN biz_project_info p ON mi.modal_id = p.modal_id AND p.deleted = 0
WHERE mi.user_id = ? AND mi.deleted = 0
ORDER BY mi.create_time DESC;
```

#### 6.3 检查模态标识是否被用户使用过
```sql
SELECT COUNT(*) as used_count
FROM user_modal
WHERE user_id = ? AND modal_id = ? AND deleted = 0;
```

### 7. 索引优化建议

- user: idx_phone, idx_grid_code, uk_two_factor_code
- biz_two_factor_code: uk_two_factor_value, idx_grid_code_value
- biz_grid_code: uk_grid_code_value
- biz_modal_identifier: uk_user_modal_value, idx_two_factor_value, idx_user_id
- biz_project_info: idx_modal_id, idx_user_id, idx_modal_value
- user_modal: uk_user_modal, idx_user_modal_user_id
- 所有表: idx_deleted (逻辑删除索引)

---

## 🎯 核心改进总结

1. ✅ **建立完整关联关系**：用户 → 双因子码 → 网格码 → 模态标识 → 项目
2. ✅ **支持一亿个模态标识**：每个双因子码可关联 0-99,999,999 个模态标识
3. ✅ **一个模态标识对应一个项目**：清晰的一对一关系
4. ✅ **逻辑外键设计**：无物理外键，性能更好，易扩展
5. ✅ **逻辑删除**：数据可恢复，审计友好
6. ✅ **历史追踪**：user_modal 表记录所有使用历史
7. ✅ **数据完整性**：在应用层（Service）控制关联完整性
