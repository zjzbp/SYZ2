# 阿里云短信验证码功能使用说明

## 一、功能说明

本项目已集成阿里云短信验证码功能,用于以下场景:
1. **用户注册** - 注册时需要手机号验证码
2. **忘记密码** - 重置密码时需要手机号验证码

## 二、配置步骤

### 1. 阿里云短信服务配置

在 `application.properties` 中配置阿里云短信参数:

```properties
# 阿里云短信配置
aliyun.sms.access-key-id=你的AccessKeyId
aliyun.sms.access-key-secret=你的AccessKeySecret
aliyun.sms.sign-name=你的短信签名
aliyun.sms.template-code=你的短信模板CODE
```

**获取步骤:**
1. 登录阿里云控制台 https://www.aliyun.com
2. 进入 "短信服务" 产品
3. 创建 AccessKey (或使用已有的)
4. 申请短信签名 (例如: "双因子系统")
5. 申请短信模板 (模板内容示例: "您的验证码为:${code},有效期5分钟")
6. 将获取的 AccessKeyId、AccessKeySecret、签名名称、模板CODE 填入配置文件

### 2. Redis 配置

验证码存储在 Redis 中,需要配置 Redis 连接:

```properties
# Redis配置
spring.data.redis.host=localhost
spring.data.redis.port=6379
spring.data.redis.password=
spring.data.redis.database=0
```

**注意:** 
- 如果本地没有 Redis,需要先安装 Redis 服务
- Windows 可下载: https://github.com/microsoftarchive/redis/releases
- 或使用远程 Redis 服务器

## 三、新增接口说明

### 1. 发送验证码接口

**请求地址:** `POST /api/user/sendCode`

**请求参数:**
- `phone` (必填) - 手机号

**返回示例:**
```json
{
  "code": 200,
  "message": "验证码发送成功",
  "data": null
}
```

### 2. 重置密码接口

**请求地址:** `POST /api/user/resetPassword`

**请求体:**
```json
{
  "phone": "13800138000",
  "verifyCode": "123456",
  "newPassword": "newpass123",
  "confirmPassword": "newpass123"
}
```

**返回示例:**
```json
{
  "code": 200,
  "message": "密码重置成功",
  "data": null
}
```

## 四、前端页面说明

### 1. 注册页面 (RegisterPage.vue)
- 增加了验证码输入框
- 增加了"发送验证码"按钮
- 发送后60秒倒计时,防止频繁发送
- 验证码为6位数字

### 2. 忘记密码页面 (ResetPasswordPage.vue)
- 新增独立的密码重置页面
- 路由: `/resetPassword`
- 通过验证码验证用户身份
- 支持设置新密码

### 3. 登录页面 (LoginPage.vue)
- 密码输入框下方增加"忘记密码?"链接
- 点击跳转到重置密码页面

## 五、验证码规则

- **验证码长度:** 6位数字
- **有效期:** 5分钟
- **发送频率限制:** 60秒内只能发送一次
- **验证后自动失效:** 验证码验证成功后会自动删除,不能重复使用

## 六、测试流程

### 测试注册功能
1. 访问注册页面 `http://localhost:8081/register`
2. 填写姓名、手机号
3. 点击"发送验证码",手机会收到验证码短信
4. 输入收到的验证码
5. 设置密码并确认
6. 点击注册

### 测试忘记密码功能
1. 访问登录页面 `http://localhost:8081/login`
2. 点击"忘记密码?"链接
3. 输入已注册的手机号
4. 点击"发送验证码"
5. 输入收到的验证码
6. 设置新密码并确认
7. 点击"重置密码"
8. 使用新密码登录

## 七、常见问题

### 1. 验证码发送失败
- 检查阿里云配置是否正确
- 检查阿里云账户余额是否充足
- 检查短信签名和模板是否已通过审核
- 检查手机号格式是否正确

### 2. Redis 连接失败
- 检查 Redis 服务是否启动
- 检查 Redis 配置 (host、port、password) 是否正确
- Windows 下可使用命令 `redis-server` 启动 Redis

### 3. 验证码验证失败
- 检查验证码是否正确
- 检查验证码是否已过期 (5分钟有效期)
- 检查验证码是否已被使用过

## 八、依赖说明

已添加以下 Maven 依赖:

```xml
<!-- 阿里云短信SDK -->
<dependency>
    <groupId>com.aliyun</groupId>
    <artifactId>dysmsapi20170525</artifactId>
    <version>2.0.24</version>
</dependency>

<!-- Redis -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

## 九、代码文件清单

### 后端新增/修改文件:
- `AliyunSmsConfig.java` - 阿里云短信配置类
- `SmsService.java` - 短信服务类
- `RedisConfig.java` - Redis 配置类
- `RegisterRequest.java` - 添加验证码字段
- `ResetPasswordRequest.java` - 重置密码请求DTO
- `UserController.java` - 新增发送验证码和重置密码接口
- `UserService.java` - 新增重置密码业务逻辑
- `application.properties` - 新增阿里云和Redis配置
- `pom.xml` - 新增依赖

### 前端新增/修改文件:
- `RegisterPage.vue` - 添加验证码输入和发送功能
- `ResetPasswordPage.vue` - 新增忘记密码页面
- `LoginPage.vue` - 添加忘记密码链接
- `router/index.js` - 添加重置密码路由

## 十、注意事项

1. **生产环境配置:** 使用环境变量或配置中心管理敏感信息,不要将 AccessKey 直接写在代码中
2. **短信费用:** 阿里云短信按条收费,注意控制发送频率避免恶意调用
3. **安全性:** 建议添加图形验证码或IP限制,防止短信轰炸
4. **Redis 持久化:** 建议开启 Redis 持久化,避免服务重启导致验证码丢失
